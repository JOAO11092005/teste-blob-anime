<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player com Progresso de Download</title>
    <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23E50914' d='M8 5v14l11-7z'/%3E%3C/svg%3E">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --theme-red: #E50914;
            --control-bg: rgba(0, 0, 0, 0.7);
            --text-color: #fff;
            --progress-bg: rgba(255, 255, 255, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body,
        html {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #000;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .video-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background-color: #000;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* ALTERADO: Estilo para o container do indicador de loading */
        .loading-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            /* Para alinhar o texto abaixo do ícone */
            justify-content: center;
            align-items: center;
            z-index: 10;
            font-size: 50px;
            color: var(--text-color);
            transition: opacity 0.5s;
        }

        .loading-indicator.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* NOVO: Estilo para o texto da porcentagem */
        .loading-indicator #progress-text {
            font-size: 24px;
            margin-top: 20px;
            font-weight: bold;
        }

        .controls-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--control-bg), transparent);
            padding: 15px 25px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 2;
        }

        .video-container:hover .controls-container,
        .video-container.paused .controls-container {
            opacity: 1;
        }

        .main-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .left-controls,
        .right-controls {
            display: flex;
            align-items: center;
        }

        .control-button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 22px;
            cursor: pointer;
            padding: 8px;
            transition: transform 0.2s;
        }

        .control-button:hover {
            transform: scale(1.1);
        }

        .volume-controls {
            display: flex;
            align-items: center;
            margin-left: 15px;
        }

        #volume-slider {
            width: 0;
            opacity: 0;
            transition: width 0.3s, opacity 0.3s;
            cursor: pointer;
        }

        .volume-controls:hover #volume-slider {
            width: 80px;
            opacity: 1;
            margin-left: 5px;
        }

        #progress-bar {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 5px;
            background: var(--progress-bg);
            border-radius: 5px;
            cursor: pointer;
            outline: none;
            transition: height 0.2s;
            margin-bottom: 10px;
        }

        #progress-bar:hover {
            height: 8px;
        }

        #progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: var(--theme-red);
            border-radius: 50%;
            cursor: pointer;
        }

        #progress-bar::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: var(--theme-red);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .time-container {
            margin-left: 15px;
            font-size: 16px;
            font-weight: bold;
        }

        .big-play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            z-index: 1;
            transition: opacity 0.3s, transform 0.2s;
        }

        .big-play-button:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }

        .video-container.playing .big-play-button {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="video-container" id="video-container">
        <video id="video"></video>
        <div class="loading-indicator" id="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i>
            <span id="progress-text">0%</span>
        </div>
        <div class="controls-container" id="controls-container">
            <div class="progress-controls"> <input type="range" id="progress-bar" value="0" min="0" max="100"
                    step="0.1"> </div>
            <div class="main-controls">
                <div class="left-controls"> <button id="play-pause-btn" class="control-button"><i
                            class="fas fa-play"></i></button>
                    <div class="volume-controls"> <button id="mute-btn" class="control-button"><i
                                class="fas fa-volume-up"></i></button> <input type="range" id="volume-slider" min="0"
                            max="1" step="0.01" value="1"> </div>
                    <div class="time-container"> <span id="current-time">00:00</span> / <span
                            id="total-time">00:00</span> </div>
                </div>
                <div class="right-controls"> <button id="fullscreen-btn" class="control-button"><i
                            class="fas fa-expand"></i></button> </div>
            </div>
        </div>
        <div class="big-play-button" id="big-play-button"><i class="fas fa-play"></i></div>
    </div>

    <script>
        // --- SELEÇÃO DOS ELEMENTOS DO DOM ---
        const videoContainer = document.getElementById('video-container');
        const video = document.getElementById('video');
        const loadingIndicator = document.getElementById('loading-indicator');
        const progressText = document.getElementById('progress-text'); // NOVO
        const videoUrl = '/api/video-proxy';

        // --- LÓGICA DE CARREGAMENTO COM INDICADOR DE PROGRESSO ---
        const loadVideo = async () => {
            try {
                const response = await fetch(videoUrl);
                if (!response.ok) throw new Error('Falha na rede ao buscar o vídeo.');

                const contentLength = response.headers.get('content-length');
                if (!contentLength) {
                    console.warn("Não foi possível obter o tamanho do vídeo. Não haverá indicador de progresso.");
                    // Se não soubermos o tamanho, voltamos ao método antigo
                    const videoBlob = await response.blob();
                    const blobUrl = URL.createObjectURL(videoBlob);
                    video.src = blobUrl;
                    return;
                }

                const total = parseInt(contentLength, 10);
                let loaded = 0;

                const reader = response.body.getReader();
                const stream = new ReadableStream({
                    start(controller) {
                        function push() {
                            reader.read().then(({ done, value }) => {
                                if (done) {
                                    controller.close();
                                    return;
                                }
                                loaded += value.length;
                                const percentage = Math.round((loaded / total) * 100);
                                progressText.textContent = `${percentage}%`; // ATUALIZA A PORCENTAGEM
                                controller.enqueue(value);
                                push();
                            });
                        }
                        push();
                    }
                });

                const streamResponse = new Response(stream);
                const videoBlob = await streamResponse.blob();
                const blobUrl = URL.createObjectURL(videoBlob);
                video.src = blobUrl;

            } catch (error) {
                console.error("Erro ao carregar o vídeo:", error);
                loadingIndicator.innerHTML = "Erro!";
            }
        };

        // --- O RESTANTE DO JAVASCRIPT PERMANECE IDÊNTICO ---
        const playPauseBtn = document.getElementById('play-pause-btn');
        const bigPlayButton = document.getElementById('big-play-button');
        const progressBar = document.getElementById('progress-bar');
        const volumeSlider = document.getElementById('volume-slider');
        const muteBtn = document.getElementById('mute-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const currentTimeElem = document.getElementById('current-time');
        const totalTimeElem = document.getElementById('total-time');
        const togglePlay = () => { if (video.paused || video.ended) video.play(); else video.pause(); };
        const updatePlayPauseIcon = () => { const icon = playPauseBtn.querySelector('i'); icon.classList.toggle('fa-play', video.paused); icon.classList.toggle('fa-pause', !video.paused); videoContainer.classList.toggle('paused', video.paused); videoContainer.classList.toggle('playing', !video.paused); };
        const formatTime = (time) => { const minutes = Math.floor(time / 60); const seconds = Math.floor(time % 60); return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; };
        const updateProgress = () => { if (isNaN(video.duration)) return; progressBar.value = (video.currentTime / video.duration) * 100; currentTimeElem.textContent = formatTime(video.currentTime); const progress = (video.currentTime / video.duration) * 100; progressBar.style.background = `linear-gradient(to right, #E50914 ${progress}%, rgba(255, 255, 255, 0.3) ${progress}%)`; };
        const setVideoProgress = () => { video.currentTime = (progressBar.value / 100) * video.duration; };
        const changeVolume = () => { video.volume = volumeSlider.value; video.muted = volumeSlider.value === 0; updateVolumeIcon(); };
        const updateVolumeIcon = () => { const icon = muteBtn.querySelector('i'); if (video.muted || video.volume === 0) { icon.className = 'fas fa-volume-mute'; } else if (video.volume > 0.5) { icon.className = 'fas fa-volume-up'; } else { icon.className = 'fas fa-volume-down'; } };
        const toggleMute = () => { video.muted = !video.muted; volumeSlider.value = video.muted ? 0 : video.volume; updateVolumeIcon(); };
        const toggleFullscreen = () => { if (!document.fullscreenElement) { videoContainer.requestFullscreen().catch(err => alert(`Erro: ${err.message}`)); } else { document.exitFullscreen(); } };
        playPauseBtn.addEventListener('click', togglePlay);
        bigPlayButton.addEventListener('click', togglePlay);
        video.addEventListener('click', togglePlay);
        video.addEventListener('dblclick', toggleFullscreen);
        video.addEventListener('play', updatePlayPauseIcon);
        video.addEventListener('pause', updatePlayPauseIcon);
        video.addEventListener('timeupdate', updateProgress);
        video.addEventListener('volumechange', updateVolumeIcon);
        video.addEventListener('loadedmetadata', () => { totalTimeElem.textContent = formatTime(video.duration); updateProgress(); });
        video.addEventListener('canplay', () => { loadingIndicator.classList.add('hidden'); });
        progressBar.addEventListener('input', setVideoProgress);
        volumeSlider.addEventListener('input', changeVolume);
        muteBtn.addEventListener('click', toggleMute);
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        document.addEventListener('keydown', (e) => { const tagName = document.activeElement.tagName.toLowerCase(); if (tagName === 'input') return; switch (e.key.toLowerCase()) { case ' ': e.preventDefault(); togglePlay(); break; case 'm': toggleMute(); break; case 'f': toggleFullscreen(); break; case 'arrowright': video.currentTime += 5; break; case 'arrowleft': video.currentTime -= 5; break; } });
        document.addEventListener('DOMContentLoaded', loadVideo);
    </script>
</body>

</html>